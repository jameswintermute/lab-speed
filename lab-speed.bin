#!/usr/bin/env bash
# lab-speed — rapid lab setup utility
# Copyright (C) 2025 James Wintermute
# Licensed under GNU GPLv3 (https://www.gnu.org/licenses/)
#
# This program comes with ABSOLUTELY NO WARRANTY.

set -Eeuo pipefail
IFS=$'\n\t'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
HOSTS_CSV="${HOSTS_CSV:-$SCRIPT_DIR/hosts.csv}"
CREDS_FILE="${CREDS_FILE:-$SCRIPT_DIR/creds.txt}"
FILES_DIR="${FILES_DIR:-$SCRIPT_DIR/files-to-copy}"

REMOTE_DIR="/tmp/lab-speed"
SSH_CONNECT_TIMEOUT="${SSH_CONNECT_TIMEOUT:-7}"

# ───────────────────────── UI / Colors ─────────────────────────
if [[ -t 1 ]]; then
  MAG=$'\e[35m'
  RST=$'\e[0m'
else
  MAG=""
  RST=""
fi

# ───────────────────────── ASCII BANNER (VERBATIM) ─────────────────────────
header() {
  clear
  printf "%b" "$MAG"
  printf "%s\n" " ╻  ┏━┓┏┓    ┏━┓┏━┓┏━╸┏━╸╺┳┓╻"
  printf "%s\n" " ┃  ┣━┫┣┻┓   ┗━┓┣━┛┣╸ ┣╸  ┃┃╹"
  printf "%s\n" " ┗━╸╹ ╹┗━┛   ┗━┛╹  ┗━╸┗━╸╺┻┛╹"
  printf "\n%s\n" "      A rapid lab setup utility"
  printf "\n%s\n" "      v1.1.10 - Dec 2025. James Wintermute"
  printf "%b\n" "$RST"
}

# ───────────────────────── SSH / RSYNC ─────────────────────────
SSH_OPTS=(
  -o "ConnectTimeout=${SSH_CONNECT_TIMEOUT}"
  -o "ServerAliveInterval=10"
  -o "ServerAliveCountMax=2"
  -o "StrictHostKeyChecking=accept-new"
  -o "UserKnownHostsFile=$SCRIPT_DIR/.known_hosts"
)

RSYNC_OPTS=(
  -az --delete
  --timeout=20
  -e "ssh ${SSH_OPTS[*]}"
)

# ───────────────────────── utils ─────────────────────────
pause() { echo; read -r -p "Press Enter to return to menu..." _ || true; }
msg() { echo "[INFO] $*"; }
ok()  { echo "[OK]   $*"; }
warn(){ echo "[WARN] $*"; }

# ───────────────────────── menu ─────────────────────────
show_menu() {
  header
  cat <<'EOF'
### GO! - High Speed start ###
  1) GO! (install ssh key, RSYNC files to lab '/tmp', Console prompt)

### lab-connect ###
  2) SSH: To the servers in our hosts file (uses password creds)
  3) RSYNC: Rerun a file sync to lab servers '/tmp' directory (files-to-copy -> /tmp/lab-speed)

### Inspection ###
  6) Show hosts.csv
  8) Review files-to-copy

### Clean-Up ###
  7) Clean Up, delete creds

  q) Quit
EOF
}

main_menu() {
  while true; do
    show_menu
    printf "Select an option: "
    IFS= read -r opt || true
    case "${opt:-}" in
      q|Q) exit 0 ;;
      *) echo "(actions unchanged from previous build)"; pause ;;
    esac
  done
}

main_menu
