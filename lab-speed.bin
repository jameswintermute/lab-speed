#!/usr/bin/env bash
# lab-speed — rapid lab setup utility
# Copyright (C) 2025 James Wintermute
# Licensed under GNU GPLv3 (https://www.gnu.org/licenses/)
# This program comes with ABSOLUTELY NO WARRANTY.
set -Eeuo pipefail
IFS=$'\n\t'

ROOT_DIR="$(cd "$(dirname "$0")" && pwd -P)"
LOG_DIR="$ROOT_DIR/logs"; mkdir -p "$LOG_DIR"
LOCAL_DIR="$ROOT_DIR/local"; mkdir -p "$LOCAL_DIR"
HOSTS_CSV="$LOCAL_DIR/hosts.csv"
CREDS_FILE="$LOCAL_DIR/credentials.txt"
FILES_DIR="$ROOT_DIR/files-to-copy"
KNOWN_HOSTS="$LOCAL_DIR/known_hosts"

# Dedicated per-project lab SSH identity (not tied to local user account)
LAB_KEY="$LOCAL_DIR/lab_speed_ed25519"
LAB_PUB="$LOCAL_DIR/lab_speed_ed25519.pub"

RUN_ID="$(date +%Y%m%d-%H%M%S)-$$"
LOG="$LOG_DIR/lab-speed-$RUN_ID.log"

# Ensure per-project known_hosts lives under local/
mkdir -p "$LOCAL_DIR"
touch "$KNOWN_HOSTS" 2>/dev/null || true
chmod 600 "$KNOWN_HOSTS" 2>/dev/null || true

# Run summary counters (updated by per-host loops)
KEY_OK=0; KEY_FAIL=0
RSYNC_OK=0; RSYNC_FAIL=0
PROMPT_OK=0; PROMPT_FAIL=0

# Robust error capture (prevents silent exits under set -e)
set -o errtrace
trap 'rc=$?; echo "[ERR] rc=$rc line=$LINENO cmd=$BASH_COMMAND" >>"$LOG"; exit $rc' ERR

MAG="\033[35m"; RST="\033[0m"
C_CYAN="\033[36m"; C_GRN="\033[32m"; C_YEL="\033[33m"; C_RED="\033[31m"
BOLD="\033[1m"

log()  { printf "%b\n" "$*" | tee -a "$LOG" >/dev/null; }
info() { log "${C_CYAN}[INFO]${RST} $*"; }
ok()   { log "${C_GRN}[ OK ]${RST} $*"; }
warn() { log "${C_YEL}[WARN]${RST} $*"; }
err()  { log "${C_RED}[ERR ]${RST} $*"; }
die()  { err "$*"; exit 1; }

header() {
  clear
  printf "%b" "$MAG"
  printf "%s\n" " ╻  ┏━┓┏┓    ┏━┓┏━┓┏━╸┏━╸╺┳┓╻"
  printf "%s\n" " ┃  ┣━┫┣┻┓   ┗━┓┣━┛┣╸ ┣╸  ┃┃╹"
  printf "%s\n" " ┗━╸╹ ╹┗━┛   ┗━┛╹  ┗━╸┗━╸╺┻┛╹"
  printf "\n%s\n" "      A rapid lab setup utility"
  printf "\n%s\n" "      v1.1.4 - Dec 2025. James Wintermute"
  printf "%b\n" "$RST"
}

progress_step() {
  cur="$1"; total="$2"; msg="$3"; done="${4:-0}"
  width=24
  filled=$(( (cur * width) / total ))
  [ "$filled" -gt "$width" ] && filled="$width"
  empty=$(( width - filled ))
  bar_filled="$(printf '%*s' "$filled" '' | tr ' ' '#')"
  bar_empty="$(printf '%*s' "$empty" '' | tr ' ' '-')"

  col="$C_CYAN"
  if [ "$done" = "1" ]; then
    col="$C_GRN"
  fi

  printf "\r%b[%s%s]%b %s/%s %s%b" "$col" "$bar_filled" "$bar_empty" "$RST" "$cur" "$total" "$msg" "$RST"

  if [ "$done" = "1" ]; then
    printf "\n"
  fi
  return 0
}

need() { command -v "$1" >/dev/null 2>&1 || return 1; }

ensure_lab_key() {
  mkdir -p "$LOCAL_DIR"
  chmod 700 "$LOCAL_DIR" 2>/dev/null || true

  if [ ! -f "$LAB_KEY" ] || [ ! -f "$LAB_PUB" ]; then
    info "Generating lab-speed SSH key in local/ ..."
    ssh-keygen -t ed25519 -a 64 -f "$LAB_KEY" -N "" -C "lab-speed $(hostname) $(date +%F)" >/dev/null
    chmod 600 "$LAB_KEY" 2>/dev/null || true
    chmod 644 "$LAB_PUB" 2>/dev/null || true
  fi
}

ssh_opts() {
  # Always use the lab-speed key stored in local/ so any local user of this repo can use it for the lab duration.
  ensure_lab_key
  echo "-o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=$KNOWN_HOSTS -o ConnectTimeout=10 -i $LAB_KEY -o IdentitiesOnly=yes"
}

ssh_opts_keyonly() {
  # Non-interactive: never prompt for password; fail fast if key isn't installed server-side.
  # Uses the per-project lab key in local/.
  echo "$(ssh_opts) -i $LAB_KEY -o IdentitiesOnly=yes -o BatchMode=yes -o PreferredAuthentications=publickey -o PasswordAuthentication=no"
}

ssh_opts_interactive() {
  # Interactive shells are allowed to prompt (used only for lab-connect).
  echo "$(ssh_opts) -o PreferredAuthentications=publickey"
}
auth_check() {
  # Returns 0 if key auth works; non-zero otherwise. Never prompts.
  host="$1"
  ssh $(ssh_opts_keyonly) -p 22 "$username@$host" "true" >/dev/null 2>&1
  return $?
}
bootstrap_key_with_password() {
  host="$1"; label="$2"
  if ! need sshpass; then
    return 127
  fi
  if [ -z "${SSHPASS:-}" ]; then
    return 2
  fi
  # Use password auth once to install our lab public key into authorized_keys
  export SSHPASS="$SSHPASS"
  sshpass -e ssh $(ssh_opts) -p 22 "$username@$host" "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys" < "$LAB_PUB" >/dev/null 2>&1
  rc=$?
  unset SSHPASS
  if [ $rc -ne 0 ]; then
    err "Password bootstrap failed for $host ($label)."
    return 1
  fi
  ok "Key installed via password bootstrap on $host ($label)."
  return 0
}

ensure_creds_file() {
  if [ ! -f "$CREDS_FILE" ]; then
    umask 077
    cat >"$CREDS_FILE" <<'EOF'
# lab-speed credentials (chmod 600)
# NOTE: this is the REMOTE lab username provided by your cloud lab (not your local Linux username)
username=""
EOF
    chmod 600 "$CREDS_FILE" 2>/dev/null || true
  fi
}

ensure_creds() {
  ensure_creds_file
  # shellcheck disable=SC1090
  . "$CREDS_FILE" || true
  if [ -z "${username:-}" ]; then
    echo
    echo "Enter your REMOTE lab username (provided by the cloud lab)."
    echo "It will be stored securely in local/credentials.txt"
    echo
    read -rp "  username: " _u
    umask 077
    {
      echo "# lab-speed credentials (chmod 600)"
      echo "# NOTE: this is the REMOTE lab username provided by your cloud lab (not your local Linux username)"
      printf 'username="%s"\n' "$_u"
    } >"$CREDS_FILE"
    chmod 600 "$CREDS_FILE" 2>/dev/null || true
    # shellcheck disable=SC1090
    . "$CREDS_FILE" || true
  fi
}

sanitize_label() { echo "$1" | tr -cd 'A-Za-z0-9._-'; }

check_dependencies() {
  missing=0
  pkgs=""

  echo
  echo "### Dependency check ###"
  for cmd in ssh ssh-keygen rsync awk sed; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
      echo "  MISSING: $cmd"
      missing=1
      case "$cmd" in
        ssh|ssh-keygen) pkgs="$pkgs openssh-client" ;;
        rsync)          pkgs="$pkgs rsync" ;;
        awk)            pkgs="$pkgs gawk" ;;
        sed)            pkgs="$pkgs sed" ;;
      esac
    else
      echo "  OK: $cmd"
    fi
  done

  if ! command -v sshpass >/dev/null 2>&1; then
    echo
    echo "  OPTIONAL: sshpass"
    echo "    (Only useful if the lab supports password authentication.)"
    echo "    Install with:"
    echo "      sudo apt-get update && sudo apt-get install -y sshpass"
  else
    echo "  OK: sshpass"
  fi

  if [ "$missing" -eq 1 ]; then
    echo
    echo "One or more REQUIRED dependencies are missing."
    echo "Install with:"
    # de-dup package list (cheap uniq)
    pkgs="$(printf "%s\n" $pkgs | awk '!seen[$0]++' | tr '\n' ' ' | sed 's/  */ /g; s/^ //; s/ $//')"
    echo "  If you have sudo:  sudo apt-get update && sudo apt-get install -y $pkgs"
    echo "  If you do NOT have sudo: ask your lab/instructor/admin to install: $pkgs"
    exit 1
  fi
  echo
}

# Supports comma OR tab separated hosts.csv. Uses function as display label (fallback LAB). Uses function as display label (fallback LAB).
iter_hosts() {
  [ -f "$HOSTS_CSV" ] || die "hosts.csv not found: $HOSTS_CSV"
  awk '
  function lcase(s) { return tolower(s) }
  function trim(s)  { gsub(/\r/,"",s); sub(/^[ \t]+/, "", s); sub(/[ \t]+$/, "", s); return s }
  NR==1 {
    delim = (index($0,"\t")>0 ? "\t" : ",")
    n = split($0, h, delim)
    for (i=1;i<=n;i++) { key=trim(lcase(h[i])); idx[key]=i }
    next
  }
  /^[ \t]*$/ { next }
  /^[ \t]*#/ { next }
  {
    n = split($0, f, delim)
    ssh_host=""
    if (("external-ip" in idx) && idx["external-ip"]<=n) ssh_host=trim(f[idx["external-ip"]])
    else if (("external_ip" in idx) && idx["external_ip"]<=n) ssh_host=trim(f[idx["external_ip"]])
    if (ssh_host=="") next

    label=""
    if (("function" in idx) && idx["function"]<=n) label=trim(f[idx["function"]])
    if (label=="") label="LAB"
    print ssh_host "|" label
  }' "$HOSTS_CSV"
}

hosts_count() {
  c=0
  while IFS='|' read -r _h _l; do c=$((c+1)); done < <(iter_hosts || true)
  echo "$c"
}

check_prereqs() {
  need ssh || die "Missing dependency: ssh"
  need rsync || die "Missing dependency: rsync"
}

validate_hosts() {
  n=0
  while IFS='|' read -r ssh_host label; do
    n=$((n+1))
    [ -z "$ssh_host" ] && die "Invalid row $n (external-ip empty)"
  done < <(iter_hosts || true)
  if [ "$n" -le 0 ]; then
    err "No hosts found in local/hosts.csv."
    err "Populate it with at least one row (comma OR tab separated) containing external-ip + function."
    return 1
  fi
  ok "hosts.csv OK ($n host(s))"
  return 0
}

# SSH key install: in key-only labs, you must provide the public key to the lab to install server-side.
push_keys() {
  check_prereqs
  ensure_creds
  ensure_lab_key

  echo
  warn "Key-based auth required."
  echo "Provide this public key to your lab admin/system to install for user '$username' (copy/paste it; do NOT run it as a command):"
  echo
  sed 's/^/  /' "$LAB_PUB"
  echo
  warn "It should be added to: ~${username}/.ssh/authorized_keys"
  echo
  return 0
}

copy_files() {
  check_prereqs
  ensure_creds
  ensure_lab_key
  [ -d "$FILES_DIR" ] || die "Missing: $FILES_DIR"

  failures=0; i=0
  while IFS='|' read -r ssh_host label; do
    i=$((i+1))
    lbl="$(sanitize_label "$label")"; [ -z "$lbl" ] && lbl="LAB"
    info "[$i] RSYNC -> $username@$ssh_host:/tmp/lab-speed/ ($lbl)"

    # Fail fast if key is not installed server-side; never prompt for password.
    ssh $(ssh_opts_keyonly) -p 22 "$username@$ssh_host" "true" >/dev/null 2>&1
    auth_rc=$?
    if [ $auth_rc -ne 0 ]; then
      failures=$((failures+1))
      err "Key auth not yet enabled for $ssh_host ($lbl). Install the public key for user \"$username\" then re-run."
      continue
    fi

    set +e
    ssh $(ssh_opts_keyonly) -p 22 "$username@$ssh_host" "sh -c 'mkdir -p /tmp/lab-speed'" >/dev/null 2>&1
    rsync -az -e "ssh $(ssh_opts_keyonly) -p 22" "$FILES_DIR/" "$username@$ssh_host:/tmp/lab-speed/" >/dev/null 2>&1
    rc=$?
    set -e

    if [ $rc -ne 0 ]; then
      failures=$((failures+1))
      RSYNC_FAIL=$((RSYNC_FAIL+1))
      err "RSYNC failed for $ssh_host ($lbl)." 
    else
      RSYNC_OK=$((RSYNC_OK+1))
      ok "RSYNC OK for $ssh_host ($lbl)." 
    fi
  done < <(iter_hosts)

  [ $failures -eq 0 ] || return 1
  return 0
}

set_prompt() {
  check_prereqs
  ensure_creds
  failures=0; i=0
  while IFS='|' read -r ssh_host label; do
    i=$((i+1))
    lbl="$(sanitize_label "$label")"; [ -z "$lbl" ] && lbl="LAB"
    info "[$i] Console setup (prompt) -> $username@$ssh_host ($lbl)"
    set +e

    # Write prompt into ~/.bashrc (most lab shells source this). Also ensure ~/.bash_profile sources ~/.bashrc.
    ssh $(ssh_opts) -p 22 -i "$LAB_KEY" -o IdentitiesOnly=yes "$username@$ssh_host" "bash -lc '
      set -e
      b=\"\$HOME/.bashrc\"
      p=\"\$HOME/.bash_profile\"
      touch \"\$b\" \"\$p\"
      # Ensure bash_profile sources bashrc (safe if repeated)
      grep -q \"lab-speed:source-bashrc\" \"\$p\" 2>/dev/null || cat >> \"\$p\" <<\"EOF\"
# lab-speed:source-bashrc
if [ -f \"\$HOME/.bashrc\" ]; then
  . \"\$HOME/.bashrc\"
fi
EOF
      # Remove any existing lab-speed prompt block in bashrc
      if grep -q \"^# lab-speed:prompt-begin\" \"\$b\" 2>/dev/null; then
        awk \"BEGIN{p=1} /^# lab-speed:prompt-begin$/{p=0} /^# lab-speed:prompt-end$/{p=1;next} p\" \"\$b\" > \"\$b.tmp\" && mv \"\$b.tmp\" \"\$b\"
      fi
      cat >> \"\$b\" <<\"EOF\"
# lab-speed:prompt-begin
# lab-speed prompt (auto-managed)
export PS1=\"[\u@\[\e[30;42m\]$lbl\[\e[0m\]\h \W]\$ \"
# lab-speed:prompt-end
EOF
    '" >/dev/null 2>&1
    rc=$?
    set -e
    if [ $rc -ne 0 ]; then
      failures=$((failures+1)); PROMPT_FAIL=$((PROMPT_FAIL+1)); err "Prompt setup failed for $ssh_host ($lbl)."
    else
      PROMPT_OK=$((PROMPT_OK+1)); ok "Prompt set for $ssh_host ($lbl). (Open a new shell, or run: source ~/.bashrc)"
    fi
  done < <(iter_hosts)
  [ $failures -eq 0 ] || return 1
  return 0
}


show_hosts() {
  echo
  echo "---- local/hosts.csv ----"
  sed 's/^/  /' "$HOSTS_CSV"
  echo "-------------------------"
}

show_files_to_copy() {
  echo
  echo "---- files-to-copy/ ----"
  (ls -lah "$FILES_DIR" 2>/dev/null || true) | sed 's/^/  /'
  echo
  count="$(find "$FILES_DIR" -type f 2>/dev/null | wc -l | tr -d ' ')"
  size="$(du -sh "$FILES_DIR" 2>/dev/null | awk '{print $1}')"
  echo "  Files: $count    Size: ${size:-0}"
  echo "------------------------"
}

go_fast_pipeline() {
  # UI flow: avoid silent exits under 'set -e'
  set +e
  ensure_lab_key
  total=4

  progress_step 1 "$total" "Validating hosts.csv" 0
  set +e
  validate_hosts
  _vh_rc=$?
  set -e
  if [ "$_vh_rc" -ne 0 ]; then
    progress_step 1 "$total" "Validating hosts.csv" 1
    read -rp "Press Enter to return..." 
    return 1
  fi
  progress_step 1 "$total" "Validating hosts.csv" 1

  progress_step 2 "$total" "Copying SSH keys" 0
  push_keys || true
  progress_step 2 "$total" "Copying SSH keys" 1

  progress_step 3 "$total" "RSYNC files to /tmp/lab-speed" 0
  copy_files || true
  progress_step 3 "$total" "RSYNC files to /tmp/lab-speed" 1

  progress_step 4 "$total" "Console setup (prompt)" 0
  set_prompt || true
  progress_step 4 "$total" "Console setup (prompt)" 1
  echo
  echo "----------------------------------------"
  info "Summary"
  ok   "SSH keys:   ${KEY_OK} success, ${KEY_FAIL} failed"
  ok   "RSYNC:      ${RSYNC_OK} host(s) updated, ${RSYNC_FAIL} failed"
  ok   "Prompt:     ${PROMPT_OK} configured, ${PROMPT_FAIL} failed"
  echo
  info "Next steps:"
  echo "  - Return to the main menu"
  echo "  - Use option 2 (lab-connect) to SSH to your servers"
  echo "----------------------------------------"
  echo
  read -rp "Press Enter to return to menu..." 

  set -e
}

refresh_hosts_prompt() {
  echo
  echo "hosts.csv appears empty (only header or no valid rows)."
  echo "Edit it now (another terminal / editor), then return."
  read -rp "Press Enter to re-check hosts.csv..."
}

go_submenu() {
  while true; do
    header
    if [ "$(hosts_count)" -eq 0 ]; then
      printf "%b\n" "${C_YEL}WARNING:${RST} local/hosts.csv has no hosts configured."
      echo
      echo "  a) Show hosts.csv"
      echo "  b) Refresh hosts.csv (after editing)"
      echo
      echo "  x) Back"
      printf "Select an option: "
      read -r s
      case "$s" in
        a|A) show_hosts ;;
        b|B) refresh_hosts_prompt ;;
        x|X) return 0 ;;
        *) echo "Invalid option"; sleep 0.8 ;;
      esac
      continue
    fi

    echo
    echo "### GO! Pre-flight checklist ###"
    echo "  a) Review files-to-copy (recommended)"
    echo "  b) Show hosts.csv"
    echo "  c) Start GO! (run all steps)"
    echo
    echo "  x) Back"
    printf "Select an option: "
    read -r s
    case "$s" in
      a|A) show_files_to_copy ;;
      b|B) show_hosts ;;
      c|C)
        echo
        printf "%b\n" "${BOLD}Before we begin:${RST} ensure everything you want copied is in:"
        echo "  $FILES_DIR"
        echo
        read -rp "Proceed with GO!? (y/N): " yn
        case "${yn:-N}" in
          y|Y) go_fast_pipeline ;;
          *) echo "Cancelled."; sleep 0.8 ;;
        esac
        ;;
      x|X) return 0 ;;
      *) echo "Invalid option"; sleep 0.8 ;;
    esac
  done
}

open_ssh_window() {
  host="$1"; user="$2"

  # lab-connect is intentionally password-first for speed.
  # If sshpass is available and credentials are set, use it to avoid prompts.
  # Otherwise fall back to normal ssh (user may be prompted).
  if need sshpass && [ -f "$CREDS_FILE" ]; then
    cmd="bash -lc 'set -e; . "$CREDS_FILE" >/dev/null 2>&1 || true; export SSHPASS="${SSHPASS:-}"; if [ -n "${SSHPASS:-}" ]; then sshpass -e ssh $(ssh_opts) -o PreferredAuthentications=password -o PubkeyAuthentication=no ${user}@${host}; else ssh $(ssh_opts) ${user}@${host}; fi'"
  else
    cmd="ssh $(ssh_opts) ${user}@${host}"
  fi

  if command -v gnome-terminal >/dev/null 2>&1; then
    gnome-terminal -- bash -lc "$cmd; echo; echo 'Session ended.'; read -n1 -r -p 'Press any key to close...'"
    return 0
  fi
  if command -v x-terminal-emulator >/dev/null 2>&1; then
    x-terminal-emulator -e bash -lc "$cmd; echo; read -n1 -r -p 'Press any key to close...'"
    return 0
  fi
  if command -v konsole >/dev/null 2>&1; then
    konsole -e bash -lc "$cmd; echo; read -n1 -r -p 'Press any key to close...'"
    return 0
  fi
  if command -v xfce4-terminal >/dev/null 2>&1; then
    xfce4-terminal --hold -e "$cmd"
    return 0
  fi
  if command -v xterm >/dev/null 2>&1; then
    xterm -e "$cmd"
    return 0
  fi
  warn "No supported terminal emulator found; running SSH in current terminal."
  exec $cmd
}


lab_connect_menu() {
  ensure_creds
  ensure_lab_key
  if [ "$(hosts_count)" -eq 0 ]; then
    header
    printf "%b\n" "${C_YEL}WARNING:${RST} local/hosts.csv has no hosts configured."
    echo
    echo "Please populate local/hosts.csv, then try again."
    read -rp "Press Enter to return..."
    return 0
  fi

  tmp="$LOG_DIR/lab-connect-$RUN_ID.list"
  rm -f "$tmp" 2>/dev/null || true
  while IFS='|' read -r h l; do
    lbl="$(sanitize_label "$l")"
    [ -z "$lbl" ] && lbl="LAB"
    printf "%s|%s\n" "$lbl" "$h" >>"$tmp"
  done < <(iter_hosts)
  sort -t'|' -k1,1 "$tmp" | head -n 25 >"${tmp}.sorted"
  mv "${tmp}.sorted" "$tmp"

  while true; do
    header
    echo "### lab-connect (SSH to servers in your hosts file) ###"
    echo
    n=0
    while IFS='|' read -r lbl h; do
      n=$((n+1))
      printf "  %2d) %s\n" "$n" "$lbl"
    done < "$tmp"
    echo
    echo "   R) Return"
    printf "Select a host: "
    read -r choice
    case "$choice" in
      r|R) return 0 ;;
      *)
        if printf "%s" "$choice" | grep -Eq '^[0-9]+$'; then
          idx="$choice"
          if [ "$idx" -lt 1 ] || [ "$idx" -gt "$n" ]; then
            echo "Invalid selection"; sleep 0.8; continue
          fi
          sel="$(sed -n "${idx}p" "$tmp")"
          sel_lbl="${sel%%|*}"
          sel_host="${sel#*|}"
          info "Opening SSH window: $username@$sel_host ($sel_lbl)"
          open_ssh_window "$sel_host" "$username"
        else
          echo "Invalid selection"; sleep 0.8
        fi
        ;;
    esac
  done
}

cleanup_creds() {
  read -rp "Are you sure you want to delete credentials? (y/N): " a
  case "$a" in y|Y) rm -f "$CREDS_FILE"; ok "Credentials removed." ;; *) info "Cancelled." ;; esac
  sleep 0.8
}

print_menu() {
  echo
  echo "### GO! - High Speed start ###"
  echo "  1) Copy ssh-keys, RSYNC files to lab '/tmp', Console setup"
  echo
  echo "### lab-connect ###"
  echo "  2) SSH to the servers in our hosts file"
  echo
  echo "### Individual functions ###"
  echo "  3) RSYNC distribute files to /tmp"
  echo "  4) Set ssh-keys (ssh-copy-id) to each host"
  echo "  5) Set ~/.bash_profile prompt from hosts.csv function"
  echo
  echo "### Inspection ###"
  echo "  6) Show hosts.csv"
  echo
  echo "### Clean-Up ###"
  echo "  7) Clean Up, delete creds"
  echo
  echo "  q) Quit"
  printf "Select an option: "
}

main() {
  header
  check_dependencies
  sleep 0.6
  ensure_creds
  ensure_lab_key
  while true; do
    header
    print_menu
    read -r c
    case "$c" in
      1) go_submenu ;;
      2) lab_connect_menu ;;
      3) copy_files; read -rp "Press Enter..." ;;
      4) push_keys; read -rp "Press Enter..." ;;
      5) set_prompt; read -rp "Press Enter..." ;;
      6) show_hosts ;;
      7) cleanup_creds ;;
      q|Q) exit 0 ;;
      *) warn "Invalid option"; sleep 0.8 ;;
    esac
  done
}

main
