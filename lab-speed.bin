#!/usr/bin/env bash
# lab-speed — rapid lab setup utility
# v1.1.19 — Dec 2025 — James Wintermute
set -Eeuo pipefail

header() {
  clear
  printf "%b" "$CLR_MAG"
  printf "%s
" " ╻  ┏━┓┏┓    ┏━┓┏━┓┏━╸┏━╸╺┳┓╻"
  printf "%s
" " ┃  ┣━┫┣┻┓   ┗━┓┣━┛┣╸ ┣╸  ┃┃╹"
  printf "%s
" " ┗━╸╹ ╹┗━┛   ┗━┛╹  ┗━╸┗━╸╺┻┛╹"
  printf "\n%s\n" "      A rapid lab setup utility"
  printf "\n%s\n" "      v1.1.19 - Dec 2025. James Wintermute"
  printf "%b\n" "$CLR_RST"
}

CLR_MAG="\033[35m"
CLR_RST="\033[0m"

ROOT="$(cd "$(dirname "$0")" && pwd)"
LOCAL="$ROOT/local"
FILES="$ROOT/files-to-copy"
KNOWN="$ROOT/.known_hosts"
LOGS="$ROOT/logs"
mkdir -p "$LOCAL" "$FILES" "$LOGS"

HOSTS_FILE="$LOCAL/hosts.csv"
CREDS_FILE="$LOCAL/credentials.txt"

progress() {
  local cur="$1" total="$2" msg="$3"
  local width=20
  local filled=$(( cur * width / total ))
  printf "\r[%-*s] %d/%d %s" "$width" "$(printf '#%.0s' $(seq 1 $filled))" "$cur" "$total" "$msg"
}

read_creds() {
  if [[ ! -f "$CREDS_FILE" ]]; then
    read -rp "Username: " u
    read -rsp "Password: " p; echo
    cat >"$CREDS_FILE"<<EOF
username="$u"
password="$p"
SSHPASS="$p"
EOF
    chmod 600 "$CREDS_FILE"
  fi
  source "$CREDS_FILE"
}

read_hosts() {
  awk -F',' 'NR>1 {print $2 "," $4}' "$HOSTS_FILE"
}

go_run() {
  read_creds
  mapfile -t HOSTS < <(read_hosts)
  local total="${#HOSTS[@]}"
  local i=0
  for line in "${HOSTS[@]}"; do
    i=$((i+1))
    IFS=',' read -r host func <<<"$line"
    progress "$i" "$total" "$func"
    sshpass -p "$SSHPASS" ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile="$KNOWN" "$username@$host" "mkdir -p /tmp/lab-speed" >/dev/null 2>&1 || true
    sshpass -p "$SSHPASS" rsync -az "$FILES/." "$username@$host:/tmp/lab-speed/" >/dev/null 2>&1 || true
  done
  echo
  echo "[OK] GO complete."
}

ssh_menu() {
  mapfile -t HOSTS < <(read_hosts)
  echo
  local i=0
  for line in "${HOSTS[@]}"; do
    i=$((i+1))
    IFS=',' read -r host func <<<"$line"
    printf " %d) %-15s (%s)\n" "$i" "$host" "$func"
  done
  read -rp "#? " sel
  IFS=',' read -r host _ <<<"${HOSTS[$((sel-1))]}"
  exec ssh "$username@$host"
}

menu() {
  while true; do
    header
    cat <<EOF
1) GO! (install ssh key, RSYNC files)
2) SSH to host
3) RSYNC again
q) Quit
EOF
    read -rp "Select an option: " c
    case "$c" in
      1) go_run; read -rp "Press Enter..." ;;
      2) read_creds; ssh_menu ;;
      3) read_creds; go_run ;;
      q) exit 0 ;;
    esac
  done
}

menu
