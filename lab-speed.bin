#!/usr/bin/env bash
set -Eeuo pipefail
IFS=$'\n\t'

# ───────────────────────── Colours ─────────────────────────
CLR_MAG="\033[35m"
CLR_GRN="\033[32m"
CLR_RED="\033[31m"
CLR_RST="\033[0m"

# ───────────────────────── ASCII BANNER (VERBATIM) ─────────────────────────
header() {
  clear
  printf "%b" "$CLR_MAG"
  printf "%s\n" " ╻  ┏━┓┏┓    ┏━┓┏━┓┏━╸┏━╸╺┳┓╻"
  printf "%s\n" " ┃  ┣━┫┣┻┓   ┗━┓┣━┛┣╸ ┣╸  ┃┃╹"
  printf "%s\n" " ┗━╸╹ ╹┗━┛   ┗━┛╹  ┗━╸┗━╸╺┻┛╹"
  printf "\n%s\n" "      A rapid lab setup utility"
  printf "\n%s\n" "      v1.1.18 - Dec 2025. James Wintermute"
  printf "%b\n" "$CLR_RST"
}

# ───────────────────────── Globals ─────────────────────────
BASE_DIR="$(cd "$(dirname "$0")" && pwd)"
LOCAL_DIR="$BASE_DIR/local"
FILES_DIR="$BASE_DIR/files-to-copy"
LOG_DIR="$BASE_DIR/logs"
KNOWN_HOSTS_FILE="$BASE_DIR/.known_hosts"

CREDS_FILE="$LOCAL_DIR/credentials.txt"
HOSTS_FILE="$LOCAL_DIR/hosts.csv"

mkdir -p "$LOG_DIR"

# Safe initialisation (set -u proof)
USERNAME=""
PASSWORD=""

# ───────────────────────── Logging ─────────────────────────
log() { printf "%s\n" "$1"; }

# ───────────────────────── Progress bar ─────────────────────────
progress_bar() {
  local current="$1"
  local total="$2"
  local label="$3"
  printf "[%d/%d] %s\n" "$current" "$total" "$label"
}

# ───────────────────────── Read credentials ─────────────────────────
load_creds() {
  if [[ ! -f "$CREDS_FILE" ]]; then
    log "[ERROR] Missing local/credentials.txt"
    exit 1
  fi
  # shellcheck disable=SC1090
  source "$CREDS_FILE"
  USERNAME="${username:-}"
  PASSWORD="${password:-}"
  if [[ -z "$USERNAME" || -z "$PASSWORD" ]]; then
    log "[ERROR] credentials.txt must define username and password"
    exit 1
  fi
}

# ───────────────────────── Read hosts ─────────────────────────
read_hosts() {
  tail -n +2 "$HOSTS_FILE" | awk -F',' '{print $2","$4}'
}

# ───────────────────────── Connectivity check ─────────────────────────
check_connectivity() {
  load_creds
  mapfile -t HOSTS < <(read_hosts)
  local total="${#HOSTS[@]}"
  local i=0
  for h in "${HOSTS[@]}"; do
    i=$((i+1))
    IFS=',' read -r host func <<<"$h"
    progress_bar "$i" "$total" "$func - $host"
    sshpass -p "$PASSWORD" ssh       -o PreferredAuthentications=password       -o PubkeyAuthentication=no       -o StrictHostKeyChecking=accept-new       -o UserKnownHostsFile="$KNOWN_HOSTS_FILE"       -o ConnectTimeout=5       "$USERNAME@$host" "true" >/dev/null
  done
}

# ───────────────────────── SSH key install ─────────────────────────
install_key() {
  load_creds
  mapfile -t HOSTS < <(read_hosts)
  local total="${#HOSTS[@]}"
  local i=0
  for h in "${HOSTS[@]}"; do
    i=$((i+1))
    IFS=',' read -r host func <<<"$h"
    progress_bar "$i" "$total" "ssh-copy-id $func"
    sshpass -p "$PASSWORD" ssh-copy-id       -o StrictHostKeyChecking=accept-new       -o UserKnownHostsFile="$KNOWN_HOSTS_FILE"       "$USERNAME@$host" >/dev/null
  done
}

# ───────────────────────── RSYNC ─────────────────────────
do_rsync() {
  mapfile -t HOSTS < <(read_hosts)
  local total="${#HOSTS[@]}"
  local i=0
  for h in "${HOSTS[@]}"; do
    i=$((i+1))
    IFS=',' read -r host func <<<"$h"
    progress_bar "$i" "$total" "rsync $func"
    rsync -az "$FILES_DIR/" "$USERNAME@$host:/tmp/lab-speed/"
  done
}

# ───────────────────────── Menu ─────────────────────────
menu() {
  header
  cat <<EOF
1) GO! (install ssh key, RSYNC files)
2) SSH to host
3) RSYNC again
q) Quit
EOF
}

# ───────────────────────── Main loop ─────────────────────────
while true; do
  menu
  read -rp "Select an option: " opt
  case "$opt" in
    1)
      check_connectivity
      install_key
      do_rsync
      ;;
    2)
      load_creds
      mapfile -t HOSTS < <(read_hosts)
      select h in "${HOSTS[@]}"; do
        IFS=',' read -r host func <<<"$h"
        ssh "$USERNAME@$host"
        break
      done
      ;;
    3)
      do_rsync
      ;;
    q)
      exit 0
      ;;
  esac
done
