#!/usr/bin/env bash
# lab-speed — rapid lab setup utility
# Copyright (C) 2025 James Wintermute
# Licensed under GNU GPLv3 (https://www.gnu.org/licenses/)
# This program comes with ABSOLUTELY NO WARRANTY.
set -Eeuo pipefail
IFS=$'\n\t'

ROOT_DIR="$(cd "$(dirname "$0")" && pwd -P)"
LOG_DIR="$ROOT_DIR/logs"; mkdir -p "$LOG_DIR"
LOCAL_DIR="$ROOT_DIR/local"; mkdir -p "$LOCAL_DIR"
HOSTS_CSV="$LOCAL_DIR/hosts.csv"
CREDS_FILE="$LOCAL_DIR/credentials.txt"
FILES_DIR="$ROOT_DIR/files-to-copy"
KNOWN_HOSTS="$ROOT_DIR/known_hosts"

RUN_ID="$(date +%Y%m%d-%H%M%S)-$$"
LOG="$LOG_DIR/lab-speed-$RUN_ID.log"

# colours
MAG="\033[35m"; RST="\033[0m"
C_CYAN="\033[36m"; C_GRN="\033[32m"; C_YEL="\033[33m"; C_RED="\033[31m"
BOLD="\033[1m"

log()  { printf "%b\n" "$*" | tee -a "$LOG" >/dev/null; }
info() { log "${C_CYAN}[INFO]${RST} $*"; }
ok()   { log "${C_GRN}[ OK ]${RST} $*"; }
warn() { log "${C_YEL}[WARN]${RST} $*"; }
err()  { log "${C_RED}[ERR ]${RST} $*"; }
die()  { err "$*"; exit 1; }

header() {
  clear
  printf "%b" "$MAG"
  printf "%s\n" " ╻  ┏━┓┏┓    ┏━┓┏━┓┏━╸┏━╸╺┳┓╻"
  printf "%s\n" " ┃  ┣━┫┣┻┓   ┗━┓┣━┛┣╸ ┣╸  ┃┃╹"
  printf "%s\n" " ┗━╸╹ ╹┗━┛   ┗━┛╹  ┗━╸┗━╸╺┻┛╹"
  printf "\n%s\n" "      A rapid lab setup utility"
  printf "\n%s\n" "      v1.0.6 - Dec 2025. James Wintermute"
  printf "%b\n" "$RST"
}

progress_step() {
  cur="$1"; total="$2"; msg="$3"; done="${4:-0}"
  width=24
  filled=$(( (cur * width) / total ))
  [ "$filled" -gt "$width" ] && filled="$width"
  empty=$(( width - filled ))
  bar_filled="$(printf '%*s' "$filled" '' | tr ' ' '#')"
  bar_empty="$(printf '%*s' "$empty" '' | tr ' ' '-')"
  col="$C_CYAN"; [ "$done" = "1" ] && col="$C_GRN"
  printf "\r%b[%s%s]%b %s/%s %s%b" "$col" "$bar_filled" "$bar_empty" "$RST" "$cur" "$total" "$msg" "$RST"
  [ "$done" = "1" ] && printf "\n"
}

need() { command -v "$1" >/dev/null 2>&1 || die "Missing dependency: $1"; }

ssh_opts() {
  echo "-o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=$KNOWN_HOSTS -o ConnectTimeout=10"
}

sh_quote() { printf "%s" "$1" | sed "s/'/'\\\\''/g; 1s/^/'/; $s/$/'/"; }

ensure_creds_file() {
  if [ ! -f "$CREDS_FILE" ]; then
    umask 077
    cat >"$CREDS_FILE" <<'EOF'
# lab-speed credentials (chmod 600)
username=""
password=""
SSHPASS=""
EOF
    chmod 600 "$CREDS_FILE" 2>/dev/null || true
  fi
}

ensure_creds() {
  ensure_creds_file
  # shellcheck disable=SC1090
  . "$CREDS_FILE" || true
  if [ -z "${username:-}" ] || [ -z "${password:-}" ] || [ -z "${SSHPASS:-}" ]; then
    echo
    echo "Please enter the following credentials for your lab."
    echo "They will be stored securely in local/credentials.txt"
    echo
    read -rp "  username: " _u
    read -rsp "  password: " _p; echo
    read -rsp "  SSHPASS (press Enter to use same as password): " _s; echo
    [ -z "${_s:-}" ] && _s="$_p"
    umask 077
    {
      echo "# lab-speed credentials (chmod 600)"
      echo "username=$(printf "%s" "$_u" | sed 's/"/\\\"/g; s/^/"/; s/$/"/')"
      echo "password=$(printf "%s" "$_p" | sed 's/"/\\\"/g; s/^/"/; s/$/"/')"
      echo "SSHPASS=$(printf "%s" "$_s" | sed 's/"/\\\"/g; s/^/"/; s/$/"/')"
    } >"$CREDS_FILE"
    chmod 600 "$CREDS_FILE" 2>/dev/null || true
    # shellcheck disable=SC1090
    . "$CREDS_FILE" || true
  fi
}

sanitize_label() { echo "$1" | tr -cd 'A-Za-z0-9._-'; }

iter_hosts() {
  [ -f "$HOSTS_CSV" ] || die "hosts.csv not found: $HOSTS_CSV"
  awk '
  function lcase(s) { return tolower(s) }
  function trim(s)  { sub(/^[ \t\r\n]+/, "", s); sub(/[ \t\r\n]+$/, "", s); return s }
  BEGIN { FS=","; OFS="|" }
  NR==1 { for (i=1;i<=NF;i++) { h=trim(lcase($i)); idx[h]=i } ; next }
  /^[ \t]*$/ { next }
  /^[ \t]*#/ { next }
  {
    ssh_host=""
    if ("external-ip" in idx)      ssh_host=trim($(idx["external-ip"]))
    else if ("external_ip" in idx) ssh_host=trim($(idx["external_ip"]))
    else if ("host" in idx)        ssh_host=trim($(idx["host"]))
    else if ("hostname" in idx)    ssh_host=trim($(idx["hostname"]))
    else if ("ip" in idx)          ssh_host=trim($(idx["ip"]))
    if (ssh_host=="") next

    label=""
    if ("function" in idx) label=trim($(idx["function"]))
    if (label=="") { if ("role" in idx) label=trim($(idx["role"])) }
    if (label=="") label="LAB"
    print ssh_host, label
  }' "$HOSTS_CSV"
}

hosts_count() {
  c=0
  while IFS='|' read -r _h _l; do c=$((c+1)); done < <(iter_hosts)
  echo "$c"
}

check_prereqs() {
  need ssh
  need rsync
  if ! command -v sshpass >/dev/null 2>&1; then
    warn "sshpass not installed (password automation limited). Install: sudo apt-get install -y sshpass"
  fi
}

validate_hosts() {
  n=0
  while IFS='|' read -r ssh_host label; do
    n=$((n+1))
    [ -z "$ssh_host" ] && die "Invalid row $n (external-ip/host/ip empty)"
  done < <(iter_hosts)
  [ "$n" -gt 0 ] || die "No usable hosts found (local/hosts.csv currently empty)."
  ok "hosts.csv OK ($n host(s))"
}

push_keys() {
  check_prereqs
  ensure_creds
  if [ ! -f "$HOME/.ssh/id_ed25519.pub" ] && [ ! -f "$HOME/.ssh/id_rsa.pub" ]; then
    info "Generating SSH key (ed25519)..."
    ssh-keygen -t ed25519 -N "" -f "$HOME/.ssh/id_ed25519" >/dev/null
  fi
  i=0
  while IFS='|' read -r ssh_host label; do
    i=$((i+1))
    lbl="$(sanitize_label "$label")"; [ -z "$lbl" ] && lbl="LAB"
    info "[$i] Copy ssh-key -> $username@$ssh_host ($lbl)"
    if command -v sshpass >/dev/null 2>&1; then
      export SSHPASS="$SSHPASS"
      sshpass -e ssh $(ssh_opts) -p 22 "$username@$ssh_host" "mkdir -p ~/.ssh && chmod 700 ~/.ssh"
      if [ -f "$HOME/.ssh/id_ed25519.pub" ]; then
        sshpass -e ssh $(ssh_opts) -p 22 "$username@$ssh_host" "cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys" < "$HOME/.ssh/id_ed25519.pub"
      else
        sshpass -e ssh $(ssh_opts) -p 22 "$username@$ssh_host" "cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys" < "$HOME/.ssh/id_rsa.pub"
      fi
      unset SSHPASS
    else
      ssh-copy-id "$username@$ssh_host"
    fi
  done < <(iter_hosts)
}

copy_files() {
  check_prereqs
  ensure_creds
  [ -d "$FILES_DIR" ] || die "Missing: $FILES_DIR"
  i=0
  while IFS='|' read -r ssh_host label; do
    i=$((i+1))
    lbl="$(sanitize_label "$label")"; [ -z "$lbl" ] && lbl="LAB"
    info "[$i] RSYNC -> $username@$ssh_host:/tmp/lab-speed/ ($lbl)"
    if command -v sshpass >/dev/null 2>&1; then
      export SSHPASS="$SSHPASS"
      rsync -az -e "ssh $(ssh_opts) -p 22" "$FILES_DIR/" "$username@$ssh_host:/tmp/lab-speed/"
      unset SSHPASS
    else
      rsync -az -e "ssh $(ssh_opts) -p 22" "$FILES_DIR/" "$username@$ssh_host:/tmp/lab-speed/"
    fi
  done < <(iter_hosts)
}

set_prompt() {
  check_prereqs
  ensure_creds
  i=0
  while IFS='|' read -r ssh_host label; do
    i=$((i+1))
    lbl="$(sanitize_label "$label")"; [ -z "$lbl" ] && lbl="LAB"
    info "[$i] Console setup (prompt) -> $username@$ssh_host ($lbl)"
    ssh $(ssh_opts) -p 22 "$username@$ssh_host" "grep -q 'lab-speed:prompt' ~/.bash_profile 2>/dev/null || cat >> ~/.bash_profile <<'EOF'
# lab-speed:prompt
export PS1=\"[\\u@[$lbl]\\h \\W]\\$ \" 
EOF"
  done < <(iter_hosts)
}

show_hosts() {
  echo
  echo "---- local/hosts.csv ----"
  sed 's/^/  /' "$HOSTS_CSV"
  echo "-------------------------"
  read -rp "Press Enter to continue..."
}

show_files_to_copy() {
  echo
  echo "---- files-to-copy/ ----"
  (ls -lah "$FILES_DIR" 2>/dev/null || true) | sed 's/^/  /'
  echo
  count="$(find "$FILES_DIR" -type f 2>/dev/null | wc -l | tr -d ' ')"
  size="$(du -sh "$FILES_DIR" 2>/dev/null | awk '{print $1}')"
  echo "  Files: $count    Size: ${size:-0}"
  echo "------------------------"
  read -rp "Press Enter to continue..."
}

go_fast_pipeline() {
  total=4
  progress_step 1 "$total" "Validating hosts.csv" 0
  validate_hosts
  progress_step 1 "$total" "Validating hosts.csv" 1

  progress_step 2 "$total" "Copying SSH keys" 0
  push_keys
  progress_step 2 "$total" "Copying SSH keys" 1

  progress_step 3 "$total" "RSYNC files to /tmp/lab-speed" 0
  copy_files
  progress_step 3 "$total" "RSYNC files to /tmp/lab-speed" 1

  progress_step 4 "$total" "Console setup (prompt)" 0
  set_prompt
  progress_step 4 "$total" "Console setup (prompt)" 1

  ok "GO! complete."
  read -rp "Press Enter to return to menu..."
}

refresh_hosts_prompt() {
  echo
  echo "hosts.csv has no hosts configured (only header or empty)."
  echo "Edit it now (another terminal / editor), then return."
  read -rp "Press Enter to re-check hosts.csv..."
}

go_submenu() {
  while true; do
    header
    if [ "$(hosts_count)" -eq 0 ]; then
      printf "%b\n" "${C_YEL}WARNING:${RST} local/hosts.csv has no hosts configured."
      echo
      echo "  a) Show hosts.csv"
      echo "  b) Refresh hosts.csv (after editing)"
      echo
      echo "  x) Back"
      printf "Select an option: "
      read -r s
      case "$s" in
        a|A) show_hosts ;;
        b|B) refresh_hosts_prompt ;;
        x|X) return 0 ;;
        *) echo "Invalid option"; sleep 0.8 ;;
      esac
      continue
    fi

    echo
    echo "### GO! Pre-flight checklist ###"
    echo "  a) Review files-to-copy (recommended)"
    echo "  b) Show hosts.csv"
    echo "  c) Start GO! (run all steps)"
    echo
    echo "  x) Back"
    printf "Select an option: "
    read -r s
    case "$s" in
      a|A) show_files_to_copy ;;
      b|B) show_hosts ;;
      c|C)
        echo
        echo "${BOLD}Before we begin:${RST} ensure everything you want copied is in:"
        echo "  $FILES_DIR"
        echo
        read -rp "Proceed with GO!? (y/N): " yn
        case "${yn:-N}" in
          y|Y) go_fast_pipeline ;;
          *) echo "Cancelled."; sleep 0.8 ;;
        esac
        ;;
      x|X) return 0 ;;
      *) echo "Invalid option"; sleep 0.8 ;;
    esac
  done
}

open_ssh_window() {
  host="$1"; user="$2"
  cmd="ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=$KNOWN_HOSTS -o ConnectTimeout=10 ${user}@${host}"
  if command -v gnome-terminal >/dev/null 2>&1; then
    gnome-terminal -- bash -lc "$cmd; echo; echo 'Session ended.'; read -n1 -r -p 'Press any key to close...'"
    return 0
  fi
  if command -v x-terminal-emulator >/dev/null 2>&1; then
    x-terminal-emulator -e bash -lc "$cmd; echo; read -n1 -r -p 'Press any key to close...'"
    return 0
  fi
  if command -v konsole >/dev/null 2>&1; then
    konsole -e bash -lc "$cmd; echo; read -n1 -r -p 'Press any key to close...'"
    return 0
  fi
  if command -v xfce4-terminal >/dev/null 2>&1; then
    xfce4-terminal --hold -e "$cmd"
    return 0
  fi
  if command -v xterm >/dev/null 2>&1; then
    xterm -e "$cmd"
    return 0
  fi
  warn "No supported terminal emulator found; running SSH in current terminal."
  exec $cmd
}

lab_connect_menu() {
  ensure_creds
  if [ "$(hosts_count)" -eq 0 ]; then
    header
    printf "%b\n" "${C_YEL}WARNING:${RST} local/hosts.csv has no hosts configured."
    echo
    echo "Please populate local/hosts.csv, then try again."
    echo
    read -rp "Press Enter to return..."
    return 0
  fi

  tmp="$LOG_DIR/lab-connect-$RUN_ID.list"
  rm -f "$tmp" 2>/dev/null || true
  while IFS='|' read -r h l; do
    lbl="$(sanitize_label "$l")"
    [ -z "$lbl" ] && lbl="LAB"
    printf "%s|%s\n" "$lbl" "$h" >>"$tmp"
  done < <(iter_hosts)
  sort -t'|' -k1,1 "$tmp" | head -n 25 >"${tmp}.sorted"
  mv "${tmp}.sorted" "$tmp"

  while true; do
    header
    echo "### lab-connect (SSH to servers in your hosts file) ###"
    echo
    n=0
    while IFS='|' read -r lbl h; do
      n=$((n+1))
      printf "  %2d) %s\n" "$n" "$lbl"
    done < "$tmp"
    echo
    echo "   R) Return"
    echo
    printf "Select a host: "
    read -r choice
    case "$choice" in
      r|R) return 0 ;;
      *)
        if printf "%s" "$choice" | grep -Eq '^[0-9]+$'; then
          idx="$choice"
          if [ "$idx" -lt 1 ] || [ "$idx" -gt "$n" ]; then
            echo "Invalid selection"; sleep 0.8; continue
          fi
          sel="$(sed -n "${idx}p" "$tmp")"
          sel_lbl="${sel%%|*}"
          sel_host="${sel#*|}"
          info "Opening SSH window: $username@$sel_host ($sel_lbl)"
          open_ssh_window "$sel_host" "$username"
        else
          echo "Invalid selection"; sleep 0.8
        fi
        ;;
    esac
  done
}

cleanup_creds() {
  read -rp "Are you sure you want to delete credentials? (y/N): " a
  case "$a" in y|Y) rm -f "$CREDS_FILE"; ok "Credentials removed." ;; *) info "Cancelled." ;; esac
  sleep 0.8
}

print_menu() {
  echo
  echo "### GO! - High Speed start ###"
  echo "  1) Copy ssh-keys, RSYNC files to lab '/tmp', Console setup"
  echo
  echo "### lab-connect ###"
  echo "  2) SSH to the servers in our hosts file"
  echo
  echo "### Individual functions ###"
  echo "  3) RSYNC distribute files to /tmp"
  echo "  4) Set ssh-keys (ssh-copy-id) to each host"
  echo "  5) Set ~/.bash_profile prompt from hosts.csv function/role"
  echo
  echo "### Inspection ###"
  echo "  6) Show hosts.csv"
  echo
  echo "### Clean-Up ###"
  echo "  7) Clean Up, delete creds"
  echo
  echo "  q) Quit"
  printf "Select an option: "
}

main() {
  header
  sleep 0.6
  ensure_creds
  while true; do
    header
    print_menu
    read -r c
    case "$c" in
      1) go_submenu ;;
      2) lab_connect_menu ;;
      3) copy_files; read -rp "Press Enter..." ;;
      4) push_keys; read -rp "Press Enter..." ;;
      5) set_prompt; read -rp "Press Enter..." ;;
      6) show_hosts ;;
      7) cleanup_creds ;;
      q|Q) exit 0 ;;
      *) warn "Invalid option"; sleep 0.8 ;;
    esac
  done
}

main
