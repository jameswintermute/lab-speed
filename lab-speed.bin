#!/usr/bin/env bash
# lab-speed — rapid lab setup utility
# v1.1.20 — Dec 2025 — James Wintermute
set -Eeuo pipefail

# Colors
CLR_MAG="\033[35m"; CLR_GRN="\033[32m"; CLR_RED="\033[31m"; CLR_YEL="\033[33m"; CLR_CYN="\033[36m"; CLR_RST="\033[0m"

# Paths
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
LOCAL_DIR="$ROOT_DIR/local"
LOGS_DIR="$ROOT_DIR/logs"
FILES_DIR="$ROOT_DIR/files-to-copy"
HOSTS_FILE="$LOCAL_DIR/hosts.csv"
CREDS_FILE="$LOCAL_DIR/credentials.txt"
KNOWN_HOSTS_FILE="$ROOT_DIR/.known_hosts"
TARGET_DIR="/tmp/lab-speed"
mkdir -p "$LOCAL_DIR" "$LOGS_DIR" "$FILES_DIR"

RUN_TAG="$(date +%Y%m%d-%H%M%S)-$$"
RUN_LOG="$LOGS_DIR/lab-speed-$RUN_TAG.log"

# ───────────────────────── ASCII BANNER (VERBATIM) ─────────────────────────
header() {
  clear
  printf "%b" "$CLR_MAG"
  printf "%s\n" " ╻  ┏━┓┏┓    ┏━┓┏━┓┏━╸┏━╸╺┳┓╻"
  printf "%s\n" " ┃  ┣━┫┣┻┓   ┗━┓┣━┛┣╸ ┣╸  ┃┃╹"
  printf "%s\n" " ┗━╸╹ ╹┗━┛   ┗━┛╹  ┗━╸┗━╸╺┻┛╹"
  printf "\n%s\n" "      A rapid lab setup utility"
  printf "\n%s\n" "      v1.1.20 - Dec 2025. James Wintermute"
  printf "%b\n" "$CLR_RST"
}

log() { printf "%b[%s]%b %s\n" "$CLR_CYN" "$1" "$CLR_RST" "$2" | tee -a "$RUN_LOG"; }
log_ok() { printf "%b[OK]%b %s\n" "$CLR_GRN" "$CLR_RST" "$1" | tee -a "$RUN_LOG"; }
log_warn() { printf "%b[WARN]%b %s\n" "$CLR_YEL" "$CLR_RST" "$1" | tee -a "$RUN_LOG"; }
log_err() { printf "%b[ERR]%b %s\n" "$CLR_RED" "$CLR_RST" "$1" | tee -a "$RUN_LOG"; }

die() { log_err "$1"; exit 1; }

trim() {
  # trim leading/trailing whitespace + CR
  local s="$1"
  s="${s//$'\r'/}"
  s="${s#${s%%[![:space:]]*}}"
  s="${s%${s##*[![:space:]]}}"
  printf "%s" "$s"
}

progress_bar() {
  local cur="$1" total="$2" label="$3"
  local width=22
  local filled=$(( (cur * width) / (total==0?1:total) ))
  local empty=$(( width - filled ))
  local bar
  bar="$(printf '%*s' "$filled" '' | tr ' ' '#')$(printf '%*s' "$empty" '' | tr ' ' '-')"
  printf "\r[%s] %d/%d %s" "$bar" "$cur" "$total" "$label"
}

ensure_creds() {
  if [[ ! -f "$CREDS_FILE" ]]; then
    mkdir -p "$LOCAL_DIR"
    cat >"$CREDS_FILE" <<'CRED'
# lab-speed credentials (chmod 600)
username=""
password=""
SSHPASS=""   # optional; if blank, password is used
CRED
    chmod 600 "$CREDS_FILE"
  fi

  # shellcheck disable=SC1090
  set +u
  source "$CREDS_FILE"
  set -u

  username="${username:-}"
  password="${password:-}"
  SSHPASS="${SSHPASS:-}"

  if [[ -z "${username}" || -z "${password}" ]]; then
    log "INFO" "Credentials missing; prompting and saving to $CREDS_FILE (chmod 600)."
    read -r -p "Lab username: " username
    read -r -s -p "Lab password: " password
    echo
    SSHPASS="${SSHPASS:-$password}"

    {
      echo "# lab-speed credentials (chmod 600)"
      printf 'username=%q\n' "$username"
      printf 'password=%q\n' "$password"
      printf 'SSHPASS=%q\n' "$SSHPASS"
    } >"$CREDS_FILE"
    chmod 600 "$CREDS_FILE"
  fi

  # Ensure sshpass uses a value
  if [[ -z "${SSHPASS}" ]]; then
    SSHPASS="$password"
  fi
}

ensure_hosts() {
  if [[ ! -f "$HOSTS_FILE" ]]; then
    mkdir -p "$LOCAL_DIR"
    cat >"$HOSTS_FILE" <<'CSV'
host-url,external-ip,internal-ip,function
https://example-cm,1.2.3.4,10.0.0.1,Splunk-CM
CSV
  fi
}

check_deps() {
  local missing=0
  for c in ssh rsync awk sed sshpass; do
    if ! command -v "$c" >/dev/null 2>&1; then
      log_err "Missing dependency: $c"
      missing=1
    else
      log_ok "$c"
    fi
  done
  if (( missing )); then
    echo
    log "INFO" "Install (Ubuntu/Debian): sudo apt-get update && sudo apt-get install -y openssh-client rsync gawk sed sshpass"
    exit 1
  fi
}

read_hosts() {
  # outputs: ip,function
  # assumes CSV has external-ip as col 2 and function as col 4
  awk -F',' 'NR>1{gsub(/\r/,"",$2); gsub(/\r/,"",$4); print $2 "," $4}' "$HOSTS_FILE" |
    sed '/^[[:space:]]*$/d'
}

rsync_to_host() {
  local ip="$1"
  local func="$2"
  ip="$(trim "$ip")"; func="$(trim "$func")"

  # Ensure remote target exists
  if ! sshpass -p "$SSHPASS" ssh \
      -o PreferredAuthentications=password \
      -o PubkeyAuthentication=no \
      -o NumberOfPasswordPrompts=1 \
      -o StrictHostKeyChecking=accept-new \
      -o UserKnownHostsFile="$KNOWN_HOSTS_FILE" \
      -o ConnectTimeout=5 \
      "${username}@${ip}" "mkdir -p '$TARGET_DIR'" >/dev/null 2>&1; then
    return 1
  fi

  # Rsync payload
  sshpass -p "$SSHPASS" rsync -az --delete \
    -e "ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o NumberOfPasswordPrompts=1 -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile='$KNOWN_HOSTS_FILE' -o ConnectTimeout=10" \
    "$FILES_DIR/" "${username}@${ip}:$TARGET_DIR/" >/dev/null 2>&1
}

go_run() {
  ensure_hosts
  ensure_creds
  check_deps

  mapfile -t hosts < <(read_hosts)
  local total="${#hosts[@]}"
  (( total > 0 )) || die "No hosts found in $HOSTS_FILE"

  log "INFO" "GO starting — provisioning $total host(s) (rsync -> $TARGET_DIR)"

  local i=0 ok=0 fail=0
  local line ip func
  for line in "${hosts[@]}"; do
    i=$((i+1))
    IFS=',' read -r ip func <<<"$line"
    ip="$(trim "$ip")"; func="$(trim "$func")"

    progress_bar "$i" "$total" "${func:-HOST}"

    if rsync_to_host "$ip" "$func"; then
      ok=$((ok+1))
    else
      fail=$((fail+1))
      echo
      log_warn "${func:-HOST} ($ip) failed (check creds/ssh access)"
    fi
  done
  echo

  if (( fail == 0 )); then
    log_ok "GO complete — ${ok}/${total} hosts ready and provisioned. RSYNC complete."
  else
    log_warn "GO finished — ${ok}/${total} hosts provisioned, ${fail} failed."
  fi

  log "INFO" "Next: choose option 2 to open SSH sessions (new terminal if available)."
}

open_ssh_terminal() {
  local title="$1" cmd="$2"

  if command -v gnome-terminal >/dev/null 2>&1; then
    gnome-terminal --title="$title" -- bash -lc "$cmd; echo; echo '[lab-speed] session ended'; read -r -p 'Press Enter to close...' _" >/dev/null 2>&1 &
    return 0
  fi

  if command -v x-terminal-emulator >/dev/null 2>&1; then
    x-terminal-emulator -T "$title" -e bash -lc "$cmd; echo; echo '[lab-speed] session ended'; read -r -p 'Press Enter to close...' _" >/dev/null 2>&1 &
    return 0
  fi

  if command -v konsole >/dev/null 2>&1; then
    konsole --new-tab -p tabtitle="$title" -e bash -lc "$cmd" >/dev/null 2>&1 &
    return 0
  fi

  return 1
}

ssh_menu() {
  ensure_hosts
  ensure_creds

  mapfile -t hosts < <(read_hosts)
  local total="${#hosts[@]}"
  (( total > 0 )) || die "No hosts found in $HOSTS_FILE"

  echo
  local i=0 line ip func
  for line in "${hosts[@]}"; do
    i=$((i+1))
    IFS=',' read -r ip func <<<"$line"
    ip="$(trim "$ip")"; func="$(trim "$func")"
    printf "%2d) %s  (%s)\n" "$i" "${func:-HOST}" "$ip"
  done

  echo
  read -r -p "Select host number (or q): " sel
  [[ "$sel" == "q" || "$sel" == "Q" ]] && return 0
  [[ "$sel" =~ ^[0-9]+$ ]] || { log_warn "Invalid selection"; return 0; }
  (( sel>=1 && sel<=total )) || { log_warn "Selection out of range"; return 0; }

  IFS=',' read -r ip func <<<"${hosts[$((sel-1))]}"
  ip="$(trim "$ip")"; func="$(trim "$func")"

  local ssh_cmd
  ssh_cmd="ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile='$KNOWN_HOSTS_FILE' -o ConnectTimeout=10 '${username}@${ip}'"

  if open_ssh_terminal "${func:-HOST}" "$ssh_cmd"; then
    log_ok "Opened SSH in a new terminal: ${func:-HOST} (${ip})"
    return 0
  fi

  log "INFO" "No supported terminal launcher found — opening SSH in this terminal."
  # shellcheck disable=SC2086
  $ssh_cmd
}

cleanup() {
  rm -f "$CREDS_FILE"
  log_ok "Deleted $CREDS_FILE"
}

menu() {
  while true; do
    header
    echo "1) GO!  (RSYNC files to lab /tmp)"
    echo "2) SSH  (open host session)"
    echo "3) RSYNC again"
    echo "4) Dependency check (manual)"
    echo "7) Clean Up (delete creds)"
    echo "q) Quit"
    echo
    read -r -p "Select an option: " opt
    case "$opt" in
      1) go_run; read -r -p "Press Enter to return to menu..." _ ;;
      2) ssh_menu; read -r -p "Press Enter to return to menu..." _ ;;
      3) go_run; read -r -p "Press Enter to return to menu..." _ ;;
      4) ensure_hosts; ensure_creds; check_deps; read -r -p "Press Enter to return to menu..." _ ;;
      7) cleanup; read -r -p "Press Enter to return to menu..." _ ;;
      q|Q) exit 0 ;;
      *) log_warn "Invalid option"; sleep 0.5 ;;
    esac
  done
}

menu
